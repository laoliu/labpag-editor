<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAG æ¨¡æ¿ç¼–è¾‘å™¨ - ç¨‹åºåŒ–ç”Ÿæˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;                <div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-left: 3px solid #2196F3; border-radius: 4px; font-size: 13px;">
                    <strong>ğŸ’¡ å¯¼å‡ºæ–¹å¼ï¼š</strong><br>
                    â€¢ <strong>æœåŠ¡ç«¯å¯¼å‡º</strong> - ä½¿ç”¨ Python æœåŠ¡å™¨ç”ŸæˆçœŸå® PAG æ–‡ä»¶ï¼ˆæ¨èï¼‰<br>
                    â€¢ <strong>é…ç½®å¯¼å‡º</strong> - å¯¼å‡º JSON é…ç½®ï¼Œä¾›åç»­æ‰¹é‡å¤„ç†ä½¿ç”¨
                </div>

                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn" onclick="downloadPAGViaServer()" style="flex: 1;">ğŸ’¾ æœåŠ¡ç«¯å¯¼å‡º PAG</button>
                    <button class="btn btn-secondary" onclick="exportJSONConfig()" style="flex: 1;">ğŸ“‹ å¯¼å‡ºé…ç½® JSON</button>
                </div>

                <div class="error" id="error"></div>      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .notice {
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #0d47a1;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            background: #eef0ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e0e7ff;
            border-color: #4c51bf;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .canvas-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .canvas {
            max-width: 100%;
            height: auto;
        }

        .layer-list {
            list-style: none;
            padding: 0;
        }

        .layer-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .layer-item:hover {
            background: #e9ecef;
        }

        .layer-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .layer-type-text {
            background: #d1ecf1;
            color: #0c5460;
        }

        .layer-type-image {
            background: #d4edda;
            color: #155724;
        }

        .history-section {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

        .history-header {
            background: #f8f9fa;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .history-header:hover {
            background: #e9ecef;
        }

        .history-toggle {
            transition: transform 0.3s ease;
        }

        .history-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .history-list {
            padding: 10px;
            background: white;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-list.hidden {
            display: none;
        }

        .history-item {
            padding: 8px 10px;
            background: #e7f3ff;
            border-left: 3px solid #0d47a1;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .history-item-type {
            font-weight: bold;
            color: #0d47a1;
        }

        .history-item-value {
            color: #495057;
            margin-left: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .info-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .success.show {
            display: block;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ PAG æ¨¡æ¿ç¼–è¾‘å™¨</h1>
        <p class="subtitle">ç¨‹åºåŒ–ä¿®æ”¹ PAG æ–‡ä»¶ - æ— éœ€ After Effects</p>

        <div class="notice">
            <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            1. ä¸Šä¼ ä¸€ä¸ª PAG æ¨¡æ¿æ–‡ä»¶<br>
            2. æŸ¥çœ‹å¹¶é€‰æ‹©è¦ä¿®æ”¹çš„å›¾å±‚<br>
            3. ä¿®æ”¹æ–‡æœ¬å†…å®¹æˆ–æ›¿æ¢å›¾ç‰‡ï¼ˆå®æ—¶é¢„è§ˆï¼‰<br>
            4. <strong>âœ¨ æ–°åŠŸèƒ½ï¼š</strong>å¯¼å‡º JSON é…ç½® â†’ ä¸€é”®åº”ç”¨å¹¶ç”Ÿæˆ PAG æ–‡ä»¶<br>
            <br>
            <strong>ğŸ“¦ å¯¼å‡ºæ–¹å¼ï¼š</strong><br>
            â€¢ <strong>æœåŠ¡ç«¯å¯¼å‡º PAG</strong> - ç›´æ¥ç”Ÿæˆå¯ç”¨çš„ PAG æ–‡ä»¶ï¼ˆéœ€å¯åŠ¨æœåŠ¡å™¨ï¼‰<br>
            â€¢ <strong>å¯¼å‡º JSON é…ç½®</strong> - ä¿å­˜é…ç½®ç”¨äºæ‰¹é‡å¤„ç†<br>
            â€¢ <strong>âš¡ åº”ç”¨ JSON å¹¶å¯¼å‡º</strong> - å°†é…ç½®ç›´æ¥åº”ç”¨åˆ°æ¨¡æ¿ç”Ÿæˆæ–° PAGï¼ˆæ¨èï¼‰
        </div>

        <div class="main-grid">
            <!-- å·¦ä¾§ï¼šä¸Šä¼ å’Œå›¾å±‚åˆ—è¡¨ -->
            <div class="panel">
                <div class="panel-title">ğŸ“‚ 1. ä¸Šä¼ æ¨¡æ¿</div>
                
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                        æ‹–æ‹½ PAG æ¨¡æ¿æ–‡ä»¶åˆ°è¿™é‡Œ
                    </div>
                    <div style="color: #666; font-size: 13px;">
                        æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
                    </div>
                    <input type="file" id="fileInput" accept=".pag" style="display: none;">
                </div>

                <div class="info-box" id="fileInfo" style="display: none;">
                    <strong>æ–‡ä»¶ä¿¡æ¯ï¼š</strong><br>
                    <span id="fileInfoText"></span>
                </div>

                <div class="panel-title" style="margin-top: 30px;">ğŸ“‹ 2. é€‰æ‹©å›¾å±‚</div>
                
                <div id="layerListContainer" style="display: none;">
                    <ul class="layer-list" id="layerList"></ul>
                </div>

                <div id="noLayersMessage" style="color: #999; text-align: center; padding: 20px;">
                    è¯·å…ˆä¸Šä¼  PAG æ–‡ä»¶
                </div>
            </div>

            <!-- å³ä¾§ï¼šç¼–è¾‘å’Œé¢„è§ˆ -->
            <div class="panel">
                <div class="panel-title">âœï¸ 3. ç¼–è¾‘å†…å®¹</div>
                
                <!-- å·²ç¼–è¾‘å†å²ï¼ˆå¯æŠ˜å ï¼‰ -->
                <div id="historySection" class="history-section" style="display: none;">
                    <div class="history-header" onclick="toggleHistory()">
                        <div>
                            <strong>ğŸ“ å·²ç¼–è¾‘å†å²</strong>
                            <span id="historyCount" style="color: #666; margin-left: 8px;">(0 é¡¹ä¿®æ”¹)</span>
                        </div>
                        <span class="history-toggle" id="historyToggle">ğŸ”½</span>
                    </div>
                    <div class="history-list" id="historyList">
                        <!-- å†å²è®°å½•å°†åŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>

                <div id="editPanel" style="display: none;">
                    <!-- å½“å‰ç¼–è¾‘å›¾å±‚ä¿¡æ¯ -->
                    <div class="info-box" id="currentLayerInfo" style="background: #e3f2fd; color: #0d47a1; font-weight: bold; margin-bottom: 15px;">
                        å½“å‰ç¼–è¾‘ï¼š<span id="currentLayerName"></span>
                    </div>

                    <div class="form-group" id="textEditGroup" style="display: none;">
                        <label class="form-label">æ–‡æœ¬å†…å®¹</label>
                        <textarea class="form-textarea" id="textInput" placeholder="è¾“å…¥æ–°çš„æ–‡æœ¬å†…å®¹..."></textarea>
                        <button class="btn" onclick="updateText()">âœ… æ›´æ–°æ–‡æœ¬</button>
                    </div>

                    <div class="form-group" id="imageEditGroup" style="display: none;">
                        <label class="form-label">æ›¿æ¢å›¾ç‰‡ (å›¾å±‚ç´¢å¼• <strong id="currentImageIndex"></strong>)</label>
                        <input type="file" class="form-input" id="imageInput" accept="image/*" onchange="previewSelectedImage()">
                        <div class="info-box">
                            æ”¯æŒ PNG, JPG, WebP æ ¼å¼
                        </div>
                        <div id="imagePreview" style="margin-top: 10px; display: none;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å·²é€‰æ‹©å›¾ç‰‡é¢„è§ˆï¼š</div>
                            <img id="imagePreviewImg" style="max-width: 100%; max-height: 200px; border-radius: 4px; border: 1px solid #ddd;" />
                        </div>
                        <button class="btn" onclick="updateImage()" style="margin-top: 10px;">âœ… æ›´æ–°å›¾ç‰‡</button>
                        
                        <!-- ğŸ†• å›¾å±‚å˜æ¢æ§åˆ¶ -->
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 12px; color: #495057;">ğŸ¨ å›¾å±‚å˜æ¢</div>
                            
                            <!-- ä½ç½® -->
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">ğŸ“ ä½ç½® (Position)</label>
                                <div style="display: flex; gap: 8px;">
                                    <div style="flex: 1;">
                                        <input type="number" id="imagePositionX" placeholder="X" step="0.1" 
                                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="number" id="imagePositionY" placeholder="Y" step="0.1"
                                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- é”šç‚¹ -->
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">âš“ é”šç‚¹ (Anchor Point)</label>
                                <div style="display: flex; gap: 8px;">
                                    <div style="flex: 1;">
                                        <input type="number" id="imageAnchorX" placeholder="X" step="0.1"
                                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="number" id="imageAnchorY" placeholder="Y" step="0.1"
                                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç¼©æ”¾ -->
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">ğŸ” ç¼©æ”¾ (Scale %)</label>
                                <div style="display: flex; gap: 8px;">
                                    <div style="flex: 1;">
                                        <input type="number" id="imageScaleX" placeholder="X" step="1" value="100"
                                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                    </div>
                                    <div style="flex: 1;">
                                        <input type="number" id="imageScaleY" placeholder="Y" step="1" value="100"
                                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                    </div>
                                    <button onclick="lockImageScale()" id="lockScaleBtn" 
                                            style="padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;"
                                            title="é”å®šæ¯”ä¾‹">ğŸ”—</button>
                                </div>
                            </div>
                            
                            <!-- æ—‹è½¬ -->
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">ğŸ”„ æ—‹è½¬ (Rotation Â°)</label>
                                <input type="number" id="imageRotation" placeholder="è§’åº¦" step="1" value="0"
                                       style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                            </div>
                            
                            <!-- ä¸é€æ˜åº¦ -->
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">ğŸ’§ ä¸é€æ˜åº¦ (Opacity %)</label>
                                <input type="range" id="imageOpacity" min="0" max="100" value="100" step="1"
                                       style="width: 100%;"
                                       oninput="document.getElementById('imageOpacityValue').textContent = this.value + '%'">
                                <span id="imageOpacityValue" style="font-size: 12px; color: #666;">100%</span>
                            </div>
                            
                            <button class="btn" onclick="applyImageTransform()" style="width: 100%; margin-top: 8px;">âœ¨ åº”ç”¨å˜æ¢</button>
                            <button class="btn btn-secondary" onclick="resetImageTransform()" style="width: 100%; margin-top: 8px;">ğŸ”„ é‡ç½®å˜æ¢</button>
                        </div>
                    </div>
                </div>

                <div id="noSelectionMessage" style="color: #999; text-align: center; padding: 40px;">
                    è¯·ä»å·¦ä¾§é€‰æ‹©è¦ç¼–è¾‘çš„å›¾å±‚
                </div>

                <div class="panel-title" style="margin-top: 30px;">ğŸ‘ï¸ 4. é¢„è§ˆæ•ˆæœ</div>
                
                <div class="canvas-container" id="canvasContainer">
                    <canvas class="canvas" id="pag"></canvas>
                </div>

                <div class="controls">
                    <button class="btn" id="playBtn" onclick="play()">â–¶ï¸ æ’­æ”¾</button>
                    <button class="btn btn-secondary" onclick="stop()">â¹ï¸ åœæ­¢</button>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 13px;">
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong> Web ç‰ˆæœ¬ä»…ç”¨äºé¢„è§ˆï¼Œæ— æ³•å¯¼å‡ºä¿®æ”¹åçš„ PAG æ–‡ä»¶ã€‚<br>
                    è¯·ä½¿ç”¨"å¯¼å‡ºé…ç½®"åŠŸèƒ½ï¼Œç„¶ååœ¨ Node.js/Python ç¯å¢ƒä¸­æ‰¹é‡ç”Ÿæˆã€‚
                </div>

                <button class="btn btn-secondary" onclick="exportJSONConfig()" style="margin-top: 10px; width: 100%;">ï¿½ å¯¼å‡ºä¿®æ”¹é…ç½® (JSON)</button>

                <div class="error" id="error"></div>
                <div class="success" id="success"></div>
            </div>
        </div>

        <!-- JSON é…ç½®ï¼ˆé«˜çº§ï¼‰ -->
        <div class="panel" style="margin-top: 20px;">
            <div class="panel-title">ğŸ”§ é«˜çº§ï¼šJSON æ‰¹é‡é…ç½®</div>
            
            <div class="form-group">
                <label class="form-label">æ‰¹é‡é…ç½® (JSON æ ¼å¼)</label>
                <textarea class="form-textarea" id="jsonConfig" placeholder='ç¤ºä¾‹:
{
  "modifications": [
    {
      "layerIndex": 0,
      "type": "text",
      "value": "æ–°çš„æ–‡æœ¬å†…å®¹"
    },
    {
      "layerIndex": 1,
      "type": "image",
      "value": "image_url_or_base64"
    }
  ]
}'></textarea>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="applyJSONConfig()">ğŸš€ åº”ç”¨ JSON é…ç½®</button>
                <button class="btn btn-secondary" onclick="exportJSONConfig()">ğŸ“‹ å¯¼å‡ºå½“å‰é…ç½®</button>
            </div>

            <div style="margin-top: 15px; padding: 12px; background: #d1f2eb; border-left: 3px solid #00c851; border-radius: 4px;">
                <strong>âœ¨ æ–°åŠŸèƒ½ï¼šä¸€é”®å¯¼å‡º PAG</strong><br>
                å°†å½“å‰çš„ JSON é…ç½®ç›´æ¥åº”ç”¨åˆ°æ¨¡æ¿ï¼Œç”Ÿæˆæ–°çš„ PAG æ–‡ä»¶
            </div>

            <button class="btn" onclick="applyJSONAndExportPAG()" style="margin-top: 10px; width: 100%; background: linear-gradient(135deg, #00c851 0%, #007e33 100%); font-weight: bold;">
                âš¡ åº”ç”¨é…ç½®å¹¶å¯¼å‡º PAG
            </button>
        </div>
    </div>

    <!-- PAG SDK -->
    <!-- 
        âš ï¸ ä½¿ç”¨æœ¬åœ°ç¼–è¯‘çš„ libpag.jsï¼ˆåŒ…å«æ–° APIï¼‰
        å°†æ‚¨ç¼–è¯‘çš„ libpag.min.js æ”¾åœ¨ä»¥ä¸‹ä»»ä¸€ä½ç½®ï¼š
        1. web/lib/libpag.min.js ï¼ˆæ¨èï¼‰
        2. æˆ–ä¿®æ”¹ä¸‹é¢çš„ src è·¯å¾„æŒ‡å‘æ‚¨çš„æ–‡ä»¶
        
        å¦‚æœæœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨é™çº§åˆ° CDNï¼ˆä¸åŒ…å«æ–° APIï¼Œä¼šä½¿ç”¨ç”»å¸ƒæˆªå›¾ï¼‰
    -->
    <!-- ä½¿ç”¨ä¼ ç»Ÿ script æ ‡ç­¾åŠ è½½ libpag (UMD æ ¼å¼) -->
    <script>
        // libpag.min.js æ˜¯ UMD æ ¼å¼,ä¼šåˆ›å»ºå…¨å±€å˜é‡ window.libpag
        (function() {
            const libpagSources = [
                './lib/libpag.min.js',
                'https://cdn.jsdelivr.net/npm/libpag@latest/lib/libpag.min.js'
            ];
            
            let currentIndex = 0;
            
            function loadNextSource() {
                if (currentIndex >= libpagSources.length) {
                    console.error('æ‰€æœ‰ libpag æºéƒ½åŠ è½½å¤±è´¥');
                    window.dispatchEvent(new CustomEvent('PAGLoadError'));
                    return;
                }
                
                const src = libpagSources[currentIndex++];
                console.log('å°è¯•åŠ è½½:', src);
                
                const script = document.createElement('script');
                script.src = src;
                
                script.onload = async function() {
                    console.log('è„šæœ¬å·²åŠ è½½:', src);
                    
                    // UMD æ ¼å¼ä¼šåˆ›å»ºå…¨å±€å˜é‡ window.libpag
                    if (typeof window.libpag === 'undefined') {
                        console.warn('window.libpag æœªå®šä¹‰ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæº');
                        loadNextSource();
                        return;
                    }
                    
                    console.log('æ£€æµ‹åˆ° window.libpag');
                    console.log('libpag keys:', Object.keys(window.libpag));
                    
                    const PAGInit = window.libpag.PAGInit;
                    
                    if (typeof PAGInit !== 'function') {
                        console.error('PAGInit ä¸æ˜¯å‡½æ•°:', typeof PAGInit);
                        loadNextSource();
                        return;
                    }
                    
                    try {
                        console.log('åˆå§‹åŒ– PAG SDK...');
                        
                        const PAG = await PAGInit({
                            locateFile: (file) => {
                                if (file.endsWith('.wasm')) {
                                    if (src.startsWith('./')) {
                                        return './lib/' + file;
                                    }
                                    return 'https://cdn.jsdelivr.net/npm/libpag@latest/lib/' + file;
                                }
                                return file;
                            }
                        });
                        
                        console.log('PAG SDK åˆå§‹åŒ–æˆåŠŸ!');
                        console.log('ç‰ˆæœ¬:', PAG.SDKVersion ? PAG.SDKVersion() : 'æœªçŸ¥');
                        
                        window.PAG = PAG;
                        window.dispatchEvent(new CustomEvent('PAGReady'));
                        
                    } catch (error) {
                        console.error('PAG åˆå§‹åŒ–å¤±è´¥:', error);
                        window.dispatchEvent(new CustomEvent('PAGLoadError'));
                    }
                };
                
                script.onerror = function(error) {
                    console.warn('è„šæœ¬åŠ è½½å¤±è´¥:', src, error);
                    loadNextSource();
                };
                
                document.head.appendChild(script);
            }
            
            loadNextSource();
        })();
    </script>

    <script>
        // ===== å·¥å…·å‡½æ•° =====
        
        /**
         * æ˜¾ç¤ºä¿¡æ¯æç¤ºï¼ˆè“è‰²ï¼‰
         */
        function showInfo(message) {
            console.log('â„¹ï¸', message);
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2196F3;
                color: white;
                padding: 12px 24px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        /**
         * æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆç»¿è‰²ï¼‰
         */
        function showSuccess(message) {
            console.log('âœ…', message);
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 12px 24px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        /**
         * æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆçº¢è‰²ï¼‰
         */
        function showError(message) {
            console.error('âŒ', message);
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 12px 24px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // ===== å…¨å±€å˜é‡ =====
        
        let pagFile = null;
        let pagView = null;
        let currentLayerIndex = null;
        let modifications = [];
        let historyCollapsed = false;
        
        // ğŸ†• ä¿å­˜åŸå§‹ PAG æ–‡ä»¶çš„ blob å’Œæ–‡ä»¶å
        let currentPagBlob = null;
        let currentFileName = '';
        let originalPagBuffer = null; // ä¿å­˜åŸå§‹ PAG æ–‡ä»¶çš„ ArrayBuffer

        // åˆå§‹åŒ– PAG SDKï¼ˆç”±è‡ªåŠ¨åŠ è½½è„šæœ¬è°ƒç”¨ï¼‰
        window.initPAG = function() {
            // PAG å·²ç”±ä¸Šé¢çš„æ¨¡å—è„šæœ¬åŠ è½½
            if (window.PAG) {
                console.log('âœ… PAG SDK å·²å‡†å¤‡å°±ç»ª');
                console.log('ğŸ” PAG å¯¹è±¡:', window.PAG);
                
                // æ¢å¤ä¸Šä¼ åŒºåŸŸå†…å®¹
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                            æ‹–æ‹½ PAG æ¨¡æ¿æ–‡ä»¶åˆ°è¿™é‡Œ
                        </div>
                        <div style="color: #666; font-size: 13px;">
                            æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
                        </div>
                        <input type="file" id="fileInput" accept=".pag" style="display: none;">
                    `;
                    uploadArea.style.opacity = '1';
                    uploadArea.style.cursor = 'pointer';
                    uploadArea.style.pointerEvents = 'auto';
                    
                    // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                    setupUploadHandlers();
                }
            } else {
                showError('PAG SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ libpag.js æ–‡ä»¶');
                
                // ç¦ç”¨ä¸Šä¼ åŒºåŸŸ
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 10px;">âŒ</div>
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #d32f2f;">
                            PAG SDK åŠ è½½å¤±è´¥
                        </div>
                        <div style="color: #666; font-size: 13px;">
                            è¯·æ£€æŸ¥ libpag.js æ–‡ä»¶æˆ–ç½‘ç»œè¿æ¥
                        </div>
                    `;
                    uploadArea.style.cursor = 'not-allowed';
                }
            }
        };
        
        // ç›‘å¬ PAG SDK åŠ è½½äº‹ä»¶
        window.addEventListener('PAGReady', () => {
            console.log('ğŸ‰ PAG SDK å·²å°±ç»ªï¼Œè°ƒç”¨ initPAG()');
            if (window.initPAG) {
                window.initPAG();
            }
        });
        
        window.addEventListener('PAGLoadError', () => {
            console.error('âŒ PAG SDK åŠ è½½å¤±è´¥');
            if (window.initPAG) {
                window.initPAG();
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">â³</div>
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                        æ­£åœ¨åŠ è½½ PAG SDK...
                    </div>
                    <div style="color: #666; font-size: 13px;">
                        è¯·ç¨å€™
                    </div>
                `;
                uploadArea.style.opacity = '0.6';
                uploadArea.style.cursor = 'wait';
                uploadArea.style.pointerEvents = 'none';
            }
        });

        // åˆ‡æ¢å†å²è®°å½•æŠ˜å çŠ¶æ€
        function toggleHistory() {
            historyCollapsed = !historyCollapsed;
            const historyList = document.getElementById('historyList');
            const historyToggle = document.getElementById('historyToggle');
            
            if (historyCollapsed) {
                historyList.classList.add('hidden');
                historyToggle.classList.add('collapsed');
                historyToggle.textContent = 'â–¶ï¸';
            } else {
                historyList.classList.remove('hidden');
                historyToggle.classList.remove('collapsed');
                historyToggle.textContent = 'ğŸ”½';
            }
        }

        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');
            const historyCount = document.getElementById('historyCount');
            
            if (modifications.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            historySection.style.display = 'block';
            historyCount.textContent = `(${modifications.length} é¡¹ä¿®æ”¹)`;
            
            historyList.innerHTML = '';
            modifications.forEach((mod, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                let displayValue = mod.value;
                if (mod.type === 'text') {
                    displayValue = displayValue.length > 30 ? displayValue.substring(0, 30) + '...' : displayValue;
                }
                
                item.innerHTML = `
                    <span class="history-item-type">${mod.type === 'text' ? 'æ–‡æœ¬' : 'å›¾ç‰‡'}å›¾å±‚ ${mod.layerIndex}:</span>
                    <span class="history-item-value">${displayValue}</span>
                `;
                historyList.appendChild(item);
            });
        }

        // è®¾ç½®ä¸Šä¼ åŒºåŸŸäº‹ä»¶ç›‘å¬å™¨
        let uploadHandlersSetup = false; // ğŸ”§ é˜²æ­¢é‡å¤ç»‘å®š
        function setupUploadHandlers() {
            if (uploadHandlersSetup) {
                console.log('âš ï¸ ä¸Šä¼ å¤„ç†å™¨å·²è®¾ç½®ï¼Œè·³è¿‡é‡å¤ç»‘å®š');
                return;
            }
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            if (!uploadArea || !fileInput) {
                console.error('âŒ ä¸Šä¼ åŒºåŸŸæˆ–æ–‡ä»¶è¾“å…¥å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            console.log('ğŸ”§ è®¾ç½®ä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨...');

            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            uploadHandlersSetup = true; // ğŸ”§ æ ‡è®°å·²è®¾ç½®
            console.log('âœ… ä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        }

        // åˆå§‹åŒ–ï¼šåœ¨ DOMContentLoaded æ—¶è®¾ç½®ä¸Šä¼ å¤„ç†å™¨
        // æ³¨æ„ï¼šå¦‚æœ SDK åŠ è½½åé‡å»ºäº† uploadAreaï¼Œéœ€è¦é‡æ–°è°ƒç”¨ setupUploadHandlers()
        // setupUploadHandlers(); // ä¸åœ¨è¿™é‡Œè°ƒç”¨ï¼Œå› ä¸º uploadArea ä¼šåœ¨ initPAG() ä¸­è¢«é‡å»º

        // å¤„ç†æ–‡ä»¶
        async function handleFile(file) {
            console.log('ğŸ“ handleFile() è¢«è°ƒç”¨ - æ–‡ä»¶å:', file.name);
            
            if (!file.name.endsWith('.pag')) {
                showError('è¯·é€‰æ‹© .pag æ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            try {
                // ç¡®ä¿ PAG SDK å·²åŠ è½½
                if (!window.PAG) {
                    showError('PAG SDK æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•...');
                    console.error('âŒ PAG SDK æœªåŠ è½½');
                    return;
                }
                
                const buffer = await file.arrayBuffer();
                originalPagBuffer = buffer.slice(0); // ä¿å­˜åŸå§‹æ–‡ä»¶çš„å‰¯æœ¬
                
                // ğŸ†• ä¿å­˜åŸå§‹æ–‡ä»¶çš„ blob å’Œæ–‡ä»¶åï¼ˆç”¨äºå‘é€ç»™åç«¯ï¼‰
                currentPagBlob = new Blob([buffer], { type: 'application/octet-stream' });
                currentFileName = file.name;
                
                console.log('ğŸ“‚ åŠ è½½ PAG æ–‡ä»¶:', file.name);
                pagFile = await window.PAG.PAGFile.load(buffer);
                
                if (!pagFile) {
                    throw new Error('æ— æ³•åŠ è½½ PAG æ–‡ä»¶');
                }

                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileInfoText').innerHTML = `
                    æ–‡ä»¶å: ${file.name}<br>
                    å°ºå¯¸: ${pagFile.width()}Ã—${pagFile.height()}<br>
                    æ—¶é•¿: ${(pagFile.duration() / 1000000).toFixed(2)}s<br>
                    å¸§ç‡: ${pagFile.frameRate()}fps
                `;

                // åˆ†æå›¾å±‚
                analyzeLayers();
                
                // æ¸²æŸ“é¢„è§ˆ
                renderPreview();
                
                showSuccess('âœ… PAG æ¨¡æ¿åŠ è½½æˆåŠŸï¼');
                
            } catch (error) {
                showError('åŠ è½½å¤±è´¥: ' + error.message);
                console.error('åŠ è½½é”™è¯¯:', error);
            }
        }

        // åˆ†æå›¾å±‚
        async function analyzeLayers() {
            console.log('ğŸ” analyzeLayers() è¢«è°ƒç”¨');
            const layerList = document.getElementById('layerList');
            console.log('ğŸ“Š æ¸…ç©ºå‰çš„å›¾å±‚æ•°é‡:', layerList.children.length);
            layerList.innerHTML = '';
            console.log('âœ… å·²æ¸…ç©ºå›¾å±‚åˆ—è¡¨');
            
            // ğŸ†• è°ƒç”¨åç«¯ API è·å–è¯¦ç»†å›¾å±‚ä¿¡æ¯
            try {
                const formData = new FormData();
                formData.append('pagFile', currentPagBlob, currentFileName);
                
                const response = await fetch('http://localhost:5000/api/analyze-layers', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`API é”™è¯¯: ${response.status}`);
                }
                
                const layerData = await response.json();
                
                console.log('å›¾å±‚è¯¦ç»†ä¿¡æ¯:', layerData);
                
                // æ·»åŠ æ–‡æœ¬å›¾å±‚
                if (layerData.textLayers) {
                    layerData.textLayers.forEach(layer => {
                        const li = document.createElement('li');
                        li.className = 'layer-item';
                        
                        let layerDetails = '';
                        if (layer.fontFamily || layer.fontSize) {
                            layerDetails = `<div style="font-size: 12px; color: #666; margin-top: 4px;">`;
                            if (layer.fontFamily) layerDetails += `å­—ä½“: ${layer.fontFamily} `;
                            if (layer.fontSize) layerDetails += `å¤§å°: ${layer.fontSize}px`;
                            layerDetails += `</div>`;
                        }
                        
                        li.innerHTML = `
                            <div>
                                <span class="layer-type layer-type-text">æ–‡æœ¬</span>
                                <span style="margin-left: 10px;">${layer.text || '(ç©ºæ–‡æœ¬)'}</span>
                                ${layerDetails}
                            </div>
                            <button onclick="selectLayer(${layer.index}, 'text')" style="padding: 5px 15px; border: none; background: #667eea; color: white; border-radius: 4px; cursor: pointer;">ç¼–è¾‘</button>
                        `;
                        layerList.appendChild(li);
                    });
                }
                
                // æ·»åŠ å›¾ç‰‡å›¾å±‚ï¼ˆå¸¦è¯¦ç»†ä¿¡æ¯ï¼‰
                if (layerData.imageLayers) {
                    layerData.imageLayers.forEach(layer => {
                        const li = document.createElement('li');
                        li.className = 'layer-item';
                        
                        // æ„å»ºè¯¦ç»†ä¿¡æ¯
                        let layerDetails = '<div style="font-size: 12px; color: #666; margin-top: 4px;">';
                        
                        // å›¾å±‚åç§°
                        const layerName = layer.name || `å›¾ç‰‡å›¾å±‚ ${layer.index + 1}`;
                        
                        // è¾¹ç•Œä¿¡æ¯
                        if (layer.bounds) {
                            const b = layer.bounds;
                            if (b.width && b.height) {
                                layerDetails += `ğŸ“ å°ºå¯¸: ${b.width.toFixed(0)}Ã—${b.height.toFixed(0)}px<br>`;
                            }
                            if (b.left !== null && b.top !== null) {
                                layerDetails += `ğŸ“ ä½ç½®: (${b.left.toFixed(0)}, ${b.top.toFixed(0)})<br>`;
                            }
                        }
                        
                        // é”šç‚¹
                        if (layer.anchorPoint) {
                            if (layer.anchorPoint.x !== undefined) {
                                layerDetails += `âš“ é”šç‚¹: (${layer.anchorPoint.x.toFixed(1)}, ${layer.anchorPoint.y.toFixed(1)})<br>`;
                            }
                        }
                        
                        // ç¼©æ”¾å› å­
                        if (layer.scaleFactor) {
                            layerDetails += `ğŸ” ç¼©æ”¾: ${layer.scaleFactor}<br>`;
                        }
                        
                        layerDetails += '</div>';
                        
                        li.innerHTML = `
                            <div style="flex: 1;">
                                <div>
                                    <span class="layer-type layer-type-image">å›¾ç‰‡</span>
                                    <span style="margin-left: 10px; font-weight: 500;">${layerName}</span>
                                </div>
                                ${layerDetails}
                            </div>
                            <button onclick="selectLayer(${layer.index}, 'image', ${JSON.stringify(layer).replace(/"/g, '&quot;')})" style="padding: 5px 15px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">ç¼–è¾‘</button>
                        `;
                        layerList.appendChild(li);
                    });
                }
                
                console.log(`ğŸ“Š æ·»åŠ å®Œæˆ - æ–‡æœ¬å›¾å±‚: ${layerData.textLayers ? layerData.textLayers.length : 0}, å›¾ç‰‡å›¾å±‚: ${layerData.imageLayers ? layerData.imageLayers.length : 0}`);
                console.log('ğŸ“Š å½“å‰å›¾å±‚åˆ—è¡¨æ€»æ•°:', layerList.children.length);
                
                document.getElementById('layerListContainer').style.display = 'block';
                document.getElementById('noLayersMessage').style.display = 'none';
                
            } catch (error) {
                console.error('è·å–å›¾å±‚ä¿¡æ¯å¤±è´¥:', error);
                // å›é€€åˆ°åŸå§‹æ–¹æ³•
                await analyzeLayersFallback();
            }
        }
        
        // åŸå§‹çš„å›¾å±‚åˆ†ææ–¹æ³•ï¼ˆä½œä¸ºå›é€€ï¼‰
        async function analyzeLayersFallback() {
            console.log('âš ï¸ analyzeLayersFallback() è¢«è°ƒç”¨ï¼ˆå›é€€æ¨¡å¼ï¼‰');
            const layerList = document.getElementById('layerList');
            console.log('ğŸ“Š æ¸…ç©ºå‰çš„å›¾å±‚æ•°é‡:', layerList.children.length);
            layerList.innerHTML = '';
            console.log('âœ… å·²æ¸…ç©ºå›¾å±‚åˆ—è¡¨ï¼ˆå›é€€æ¨¡å¼ï¼‰');
            
            // PAG SDK æä¾›çš„å›¾å±‚åˆ†ææ–¹æ³•
            const numImages = pagFile.numImages();
            const numTexts = pagFile.numTexts();
            
            console.log(`å›¾å±‚åˆ†æ: ${numImages} ä¸ªå›¾ç‰‡, ${numTexts} ä¸ªæ–‡æœ¬`);
            
            // æ·»åŠ æ–‡æœ¬å›¾å±‚
            for (let i = 0; i < numTexts; i++) {
                const textData = await pagFile.getTextData(i);
                const li = document.createElement('li');
                li.className = 'layer-item';
                li.innerHTML = `
                    <div>
                        <span class="layer-type layer-type-text">æ–‡æœ¬</span>
                        <span style="margin-left: 10px;">${textData.text || '(ç©ºæ–‡æœ¬)'}</span>
                    </div>
                    <button onclick="selectLayer(${i}, 'text')" style="padding: 5px 15px; border: none; background: #667eea; color: white; border-radius: 4px; cursor: pointer;">ç¼–è¾‘</button>
                `;
                layerList.appendChild(li);
            }
            
            // æ·»åŠ å›¾ç‰‡å›¾å±‚
            for (let i = 0; i < numImages; i++) {
                const li = document.createElement('li');
                li.className = 'layer-item';
                li.innerHTML = `
                    <div>
                        <span class="layer-type layer-type-image">å›¾ç‰‡</span>
                        <span style="margin-left: 10px;">å›¾ç‰‡å›¾å±‚ ${i + 1}</span>
                    </div>
                    <button onclick="selectLayer(${i}, 'image')" style="padding: 5px 15px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">ç¼–è¾‘</button>
                `;
                layerList.appendChild(li);
            }
            
            document.getElementById('layerListContainer').style.display = 'block';
            document.getElementById('noLayersMessage').style.display = 'none';
        }

        // é€‰æ‹©å›¾å±‚
        function selectLayer(index, type, layerInfo = null) {
            currentLayerIndex = index;
            
            document.getElementById('editPanel').style.display = 'block';
            document.getElementById('noSelectionMessage').style.display = 'none';
            
            // æ¸…é™¤ä¹‹å‰é€‰æ‹©çš„æ–‡ä»¶
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            
            if (type === 'text') {
                document.getElementById('textEditGroup').style.display = 'block';
                document.getElementById('imageEditGroup').style.display = 'none';
                
                // æ›´æ–°å½“å‰å›¾å±‚ä¿¡æ¯
                pagFile.getTextData(index).then(textData => {
                    document.getElementById('textInput').value = textData.text || '';
                    document.getElementById('currentLayerName').textContent = `æ–‡æœ¬å›¾å±‚ ${index} - "${textData.text || '(ç©º)'}"`;
                });
            } else if (type === 'image') {
                document.getElementById('textEditGroup').style.display = 'none';
                document.getElementById('imageEditGroup').style.display = 'block';
                
                // ğŸ†• æ˜¾ç¤ºè¯¦ç»†çš„å›¾å±‚ä¿¡æ¯
                let layerNameText = `å›¾ç‰‡å›¾å±‚ ${index}`;
                let detailsHTML = '';
                
                if (layerInfo) {
                    if (layerInfo.name) {
                        layerNameText = layerInfo.name;
                    }
                    
                    // æ„å»ºè¯¦ç»†ä¿¡æ¯é¢æ¿
                    detailsHTML = '<div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px;">';
                    detailsHTML += '<strong style="color: #495057;">ğŸ“Š å›¾å±‚è¯¦ç»†ä¿¡æ¯</strong><br><br>';
                    
                    if (layerInfo.bounds) {
                        const b = layerInfo.bounds;
                        if (b.width && b.height) {
                            detailsHTML += `<div style="margin-bottom: 8px;">ğŸ“ <strong>å°ºå¯¸:</strong> ${b.width.toFixed(0)} Ã— ${b.height.toFixed(0)} åƒç´ </div>`;
                        }
                        if (b.left !== null && b.top !== null) {
                            detailsHTML += `<div style="margin-bottom: 8px;">ğŸ“ <strong>ä½ç½®:</strong> X: ${b.left.toFixed(1)}, Y: ${b.top.toFixed(1)}</div>`;
                        }
                        if (b.right !== null && b.bottom !== null) {
                            detailsHTML += `<div style="margin-bottom: 8px;">ğŸ“ <strong>è¾¹ç•Œ:</strong> Right: ${b.right.toFixed(1)}, Bottom: ${b.bottom.toFixed(1)}</div>`;
                        }
                    }
                    
                    if (layerInfo.anchorPoint) {
                        if (layerInfo.anchorPoint.x !== undefined) {
                            detailsHTML += `<div style="margin-bottom: 8px;">âš“ <strong>é”šç‚¹:</strong> X: ${layerInfo.anchorPoint.x.toFixed(2)}, Y: ${layerInfo.anchorPoint.y.toFixed(2)}</div>`;
                        }
                    }
                    
                    if (layerInfo.scaleFactor) {
                        detailsHTML += `<div style="margin-bottom: 8px;">ğŸ” <strong>ç¼©æ”¾å› å­:</strong> ${layerInfo.scaleFactor}</div>`;
                    }
                    
                    if (layerInfo.matrix) {
                        detailsHTML += `<div style="margin-bottom: 8px; font-size: 11px; color: #6c757d;">ğŸ”§ <strong>å˜æ¢çŸ©é˜µ:</strong> ${layerInfo.matrix}</div>`;
                    }
                    
                    detailsHTML += '</div>';
                    
                    // ğŸ†• æ·»åŠ åˆ·æ–°é¢„è§ˆæŒ‰é’®ï¼ˆé¢„è§ˆä¼šè‡ªåŠ¨åŠ è½½ï¼Œæ­¤æŒ‰é’®ç”¨äºåˆ·æ–°ï¼‰
                    detailsHTML += '<div style="margin-top: 12px;">';
                    detailsHTML += `<button onclick="renderLayerPreview(${index})" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">ï¿½ åˆ·æ–°é¢„è§ˆ</button>`;
                    detailsHTML += '<span style="margin-left: 10px; font-size: 12px; color: #6c757d;">é¢„è§ˆå·²è‡ªåŠ¨åŠ è½½</span>';
                    detailsHTML += '</div>';
                }
                
                // æ›´æ–°å½“å‰å›¾å±‚ä¿¡æ¯
                document.getElementById('currentLayerName').textContent = layerNameText;
                document.getElementById('currentImageIndex').textContent = index;
                
                // ğŸ†• å¡«å……å›¾å±‚å˜æ¢å‚æ•°
                if (layerInfo) {
                    // ä½ç½®
                    if (layerInfo.bounds) {
                        document.getElementById('imagePositionX').value = layerInfo.bounds.left || 0;
                        document.getElementById('imagePositionY').value = layerInfo.bounds.top || 0;
                    }
                    
                    // é”šç‚¹
                    if (layerInfo.anchorPoint) {
                        document.getElementById('imageAnchorX').value = layerInfo.anchorPoint.x || 0;
                        document.getElementById('imageAnchorY').value = layerInfo.anchorPoint.y || 0;
                    }
                    
                    // ç¼©æ”¾ (å‡è®¾ scaleFactor æ˜¯ 1.0 = 100%)
                    if (layerInfo.scaleFactor !== undefined) {
                        const scale = layerInfo.scaleFactor * 100;
                        document.getElementById('imageScaleX').value = scale;
                        document.getElementById('imageScaleY').value = scale;
                    }
                    
                    // å…¶ä»–å˜æ¢å‚æ•°å¯ä»¥ä»åç«¯APIè·å–æˆ–ä½¿ç”¨é»˜è®¤å€¼
                    document.getElementById('imageRotation').value = 0; // é»˜è®¤å€¼
                    document.getElementById('imageOpacity').value = 100; // é»˜è®¤å€¼
                    document.getElementById('imageOpacityValue').textContent = '100%';
                }
                
                // æ˜¾ç¤ºæˆ–éšè—è¯¦ç»†ä¿¡æ¯
                let detailsContainer = document.getElementById('layerDetailsContainer');
                if (!detailsContainer) {
                    // åˆ›å»ºè¯¦ç»†ä¿¡æ¯å®¹å™¨
                    detailsContainer = document.createElement('div');
                    detailsContainer.id = 'layerDetailsContainer';
                    document.getElementById('imageEditGroup').insertBefore(
                        detailsContainer,
                        document.getElementById('imageEditGroup').firstChild
                    );
                }
                detailsContainer.innerHTML = detailsHTML;
                
                // ğŸ†• è‡ªåŠ¨æ¸²æŸ“å›¾å±‚é¢„è§ˆ
                console.log('ğŸ¬ è‡ªåŠ¨æ¸²æŸ“å›¾å±‚é¢„è§ˆ...');
                setTimeout(() => {
                    renderLayerPreview(index);
                }, 100); // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿ DOM å·²æ›´æ–°
            }
        }
        
        // ğŸ†• æ¸²æŸ“å›¾å±‚é¢„è§ˆï¼ˆä½¿ç”¨æ–°çš„ libpag APIï¼‰
        async function renderLayerPreview(layerIndex) {
            try {
                console.log('ğŸ¨ æ¸²æŸ“å›¾å±‚é¢„è§ˆ');
                console.log('å›¾å±‚ç´¢å¼•:', layerIndex);
                
                if (!pagFile) {
                    throw new Error('PAG æ–‡ä»¶æœªåŠ è½½');
                }
                
                showInfo('æ­£åœ¨æ¸²æŸ“å›¾å±‚é¢„è§ˆ...');
                
                // ğŸ”§ ä½¿ç”¨æ­£ç¡®çš„ API è·å–å›¾ç‰‡å›¾å±‚
                // PAG Web SDK ä¸­ï¼Œå›¾ç‰‡å›¾å±‚éœ€è¦é€šè¿‡ getLayersByEditableIndex è·å–
                const LayerType = {
                    Unknown: 0,
                    Null: 1,
                    Solid: 2,
                    Text: 3,
                    Shape: 4,
                    Image: 5,  // å›¾ç‰‡å›¾å±‚ç±»å‹æ˜¯ 5
                    PreCompose: 6
                };
                
                console.log('ğŸ“Š è°ƒç”¨ getLayersByEditableIndex...');
                const imageLayers = pagFile.getLayersByEditableIndex(layerIndex, LayerType.Image);
                
                if (!imageLayers || imageLayers.size() === 0) {
                    throw new Error(`æ— æ³•è·å–å›¾ç‰‡å›¾å±‚ ${layerIndex}`);
                }
                
                const layer = imageLayers.get(0);
                console.log('âœ… æˆåŠŸè·å–å›¾å±‚:', layer);
                console.log('å›¾å±‚ç±»å‹:', layer.layerType());
                
                let imageData = null;
                let imageSource = '';
                let imageWidth = 0;
                let imageHeight = 0;
                
                // å›¾å±‚å·²ç»æ˜¯å›¾ç‰‡å›¾å±‚(é€šè¿‡ LayerType.Image è¿‡æ»¤)
                console.log('âœ… è¿™æ˜¯å›¾ç‰‡å›¾å±‚ï¼Œå°è¯•è·å–åŸå§‹å›¾ç‰‡...');
                
                // âœ… ä½¿ç”¨ç°æœ‰ APIï¼šimageBytes() - è¿”å›é»˜è®¤å›¾ç‰‡æ•°æ®(webp æ ¼å¼)
                if (typeof layer.imageBytes === 'function') {
                    console.log('ğŸ“Š è°ƒç”¨ imageBytes()...');
                    
                    try {
                        const imageBytes = layer.imageBytes();
                        
                        if (imageBytes && imageBytes.length > 0) {
                            console.log(`âœ… è·å–åˆ°åŸå§‹å›¾ç‰‡æ•°æ®: ${imageBytes.length} bytes (WebP æ ¼å¼)`);
                            
                            // å°† Uint8Array è½¬æ¢ä¸º Blob
                            const blob = new Blob([imageBytes], { type: 'image/webp' });
                            imageData = URL.createObjectURL(blob);
                            imageSource = 'imageBytes() (WebP)';
                            console.log('âœ… ä½¿ç”¨ imageBytes() æˆåŠŸ');
                            
                            // ğŸ”§ ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆä»¥è·å–æ­£ç¡®çš„å°ºå¯¸
                            await new Promise((resolve, reject) => {
                                const img = new Image();
                                img.onload = function() {
                                    imageWidth = img.width;
                                    imageHeight = img.height;
                                    console.log(`å›¾ç‰‡å°ºå¯¸: ${imageWidth} Ã— ${imageHeight}`);
                                    resolve();
                                };
                                img.onerror = function(err) {
                                    console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', err);
                                    reject(err);
                                };
                                img.src = imageData;
                            });
                        } else {
                            console.warn('âš ï¸ imageBytes() è¿”å›ç©ºæ•°æ®');
                        }
                    } catch (err) {
                        console.error('âŒ imageBytes() è°ƒç”¨å¤±è´¥:', err);
                    }
                } else {
                    console.warn('âš ï¸ å›¾å±‚æ²¡æœ‰ imageBytes() æ–¹æ³•');
                }
                
                // å¦‚æœæ²¡æœ‰è·å–åˆ°åŸå§‹å›¾ç‰‡ï¼Œå°è¯• getReplacedImage()
                if (!imageData && typeof layer.getReplacedImage === 'function') {
                    console.log('ğŸ“Š å°è¯• getReplacedImage()...');
                    
                    try {
                        const replacedImage = layer.getReplacedImage();
                        
                        if (replacedImage) {
                            console.log('âœ… è·å–åˆ°æ›¿æ¢åçš„å›¾ç‰‡');
                            
                            if (typeof replacedImage.width === 'function') {
                                imageWidth = replacedImage.width();
                                imageHeight = replacedImage.height();
                            }
                            
                            if (typeof replacedImage.toPNG === 'function') {
                                const pngBlob = await replacedImage.toPNG();
                                if (pngBlob) {
                                    imageData = URL.createObjectURL(pngBlob);
                                    imageSource = 'getReplacedImage() + toPNG()';
                                    console.log('âœ… ä½¿ç”¨ getReplacedImage() æˆåŠŸ');
                                }
                            }
                        }
                    } catch (err) {
                        console.error('âŒ getReplacedImage() è°ƒç”¨å¤±è´¥:', err);
                    }
                }
                
                // å¦‚æœè¿˜æ˜¯æ²¡æœ‰å›¾ç‰‡æ•°æ®ï¼Œé™çº§åˆ°ä½¿ç”¨å®Œæ•´ç”»å¸ƒ
                if (!imageData) {
                    console.log('ğŸ“Š é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨å®Œæ•´ PAG ç”»å¸ƒé¢„è§ˆ');
                    
                    const mainCanvas = document.getElementById('pag');
                    if (mainCanvas) {
                        console.log('âœ… æ‰¾åˆ°ä¸»ç”»å¸ƒ (WebGL)');
                        console.log('ç”»å¸ƒå°ºå¯¸:', mainCanvas.width, 'x', mainCanvas.height);
                        
                        if (mainCanvas.width > 0 && mainCanvas.height > 0) {
                            // WebGL ç”»å¸ƒå¯ä»¥ç›´æ¥ä½¿ç”¨ toDataURL()
                            try {
                                imageData = mainCanvas.toDataURL('image/png');
                                imageSource = 'å®Œæ•´ç”»å¸ƒæˆªå›¾';
                                imageWidth = mainCanvas.width;
                                imageHeight = mainCanvas.height;
                                console.log('âœ… æˆåŠŸä» WebGL ç”»å¸ƒç”Ÿæˆ Data URL');
                                console.log('Data URL é•¿åº¦:', imageData.length);
                            } catch (e) {
                                console.error('âŒ toDataURL å¤±è´¥:', e);
                                throw new Error('æ— æ³•ä»ç”»å¸ƒç”Ÿæˆå›¾ç‰‡: ' + e.message);
                            }
                        } else {
                            console.warn('âš ï¸ ç”»å¸ƒå°ºå¯¸ä¸º 0');
                            throw new Error('ç”»å¸ƒå°ºå¯¸æ— æ•ˆ');
                        }
                    } else {
                        console.error('âŒ æ‰¾ä¸åˆ° ID ä¸º "pag" çš„ç”»å¸ƒå…ƒç´ ');
                        throw new Error('æ— æ³•è·å–å›¾å±‚å›¾ç‰‡ï¼Œä¹Ÿæ— æ³•è·å–ä¸»ç”»å¸ƒ');
                    }
                }
                
                // åˆ›å»ºé¢„è§ˆå®¹å™¨
                let previewContainer = document.getElementById('layerPreviewContainer');
                if (!previewContainer) {
                    previewContainer = document.createElement('div');
                    previewContainer.id = 'layerPreviewContainer';
                    previewContainer.style.cssText = 'margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; text-align: center;';
                    
                    const detailsContainer = document.getElementById('layerDetailsContainer');
                    if (detailsContainer) {
                        detailsContainer.appendChild(previewContainer);
                    } else {
                        throw new Error('æ‰¾ä¸åˆ°è¯¦ç»†ä¿¡æ¯å®¹å™¨');
                    }
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const layerName = layer.layerName() || `å›¾å±‚ ${layerIndex}`;
                const isOriginalImage = imageSource.includes('imageBytes');
                
                previewContainer.innerHTML = `
                    <div style="margin-bottom: 8px; font-weight: bold; color: #495057;">
                        ${isOriginalImage ? 'ğŸ–¼ï¸ åŸå§‹å›¾å±‚å›¾ç‰‡ (WebP)' : 'ğŸ–¼ï¸ é¢„è§ˆ'}
                    </div>
                    <div style="background: #fff; padding: 8px; display: inline-block; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <img src="${imageData}" style="max-width: 100%; max-height: 400px; border: 1px solid #dee2e6; border-radius: 4px; display: block;" />
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #6c757d;">
                        ğŸ“Š å›¾å±‚åç§°: ${layerName}<br>
                        ğŸ“ å°ºå¯¸: ${imageWidth} Ã— ${imageHeight}px<br>
                        ğŸ” æ¥æº: ${imageSource}
                    </div>
                    ${isOriginalImage ? `
                        <div style="margin-top: 8px; padding: 8px; background: #d4edda; border-radius: 4px; font-size: 11px; color: #155724;">
                            âœ… <strong>æˆåŠŸè·å–åŸå§‹å›¾ç‰‡æ•°æ®ï¼</strong><br>
                            ä½¿ç”¨ <code>imageBytes()</code> API è·å– WebP æ ¼å¼å›¾ç‰‡
                        </div>
                    ` : `
                        <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 11px; color: #856404;">
                            â„¹ï¸ å½“å‰æ˜¾ç¤ºçš„æ˜¯${imageSource}ï¼Œéå›¾ç‰‡å›¾å±‚æˆ– imageBytes() API ä¸å¯ç”¨
                        </div>
                    `}
                `;
                
                showSuccess('âœ… é¢„è§ˆæ¸²æŸ“æˆåŠŸï¼');
                
            } catch (error) {
                showError('ç”Ÿæˆé¢„è§ˆå¤±è´¥: ' + error.message);
                console.error('âŒ é¢„è§ˆé”™è¯¯è¯¦æƒ…:', error);
                
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                let previewContainer = document.getElementById('layerPreviewContainer');
                if (!previewContainer) {
                    previewContainer = document.createElement('div');
                    previewContainer.id = 'layerPreviewContainer';
                    previewContainer.style.cssText = 'margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;';
                    
                    const detailsContainer = document.getElementById('layerDetailsContainer');
                    if (detailsContainer) {
                        detailsContainer.appendChild(previewContainer);
                    }
                }
                
                previewContainer.innerHTML = `
                    <div style="padding: 12px; background: #f8d7da; color: #721c24; border-radius: 4px;">
                        <strong>âŒ é¢„è§ˆå¤±è´¥</strong><br>
                        é”™è¯¯ä¿¡æ¯: ${error.message}<br><br>
                        è¯·æŒ‰ F12 æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
                    </div>
                `;
            }
        }

        // é¢„è§ˆé€‰ä¸­çš„å›¾ç‰‡
        function previewSelectedImage() {
            const file = document.getElementById('imageInput').files[0];
            if (!file) {
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreviewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // æ›´æ–°æ–‡æœ¬
        async function updateText() {
            if (currentLayerIndex === null) return;
            
            const newText = document.getElementById('textInput').value;
            
            try {
                const textData = await pagFile.getTextData(currentLayerIndex);
                textData.text = newText;
                await pagFile.replaceText(currentLayerIndex, textData);
                
                modifications.push({
                    layerIndex: currentLayerIndex,
                    type: 'text',
                    value: newText
                });
                
                updateHistoryDisplay(); // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
                await renderPreview();
                showSuccess('âœ… æ–‡æœ¬æ›´æ–°æˆåŠŸï¼');
                
            } catch (error) {
                showError('æ›´æ–°æ–‡æœ¬å¤±è´¥: ' + error.message);
            }
        }

        // ğŸ†• é”å®šç¼©æ”¾æ¯”ä¾‹
        let scaleLocked = false;
        function lockImageScale() {
            scaleLocked = !scaleLocked;
            const btn = document.getElementById('lockScaleBtn');
            btn.textContent = scaleLocked ? 'ğŸ”’' : 'ğŸ”—';
            btn.title = scaleLocked ? 'å·²é”å®šæ¯”ä¾‹' : 'é”å®šæ¯”ä¾‹';
            
            if (scaleLocked) {
                // åŒæ­¥ç¼©æ”¾å€¼
                const scaleX = document.getElementById('imageScaleX').value;
                document.getElementById('imageScaleY').value = scaleX;
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                document.getElementById('imageScaleX').addEventListener('input', syncScale);
                document.getElementById('imageScaleY').addEventListener('input', syncScale);
            } else {
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                document.getElementById('imageScaleX').removeEventListener('input', syncScale);
                document.getElementById('imageScaleY').removeEventListener('input', syncScale);
            }
        }
        
        function syncScale(e) {
            if (!scaleLocked) return;
            const value = e.target.value;
            document.getElementById('imageScaleX').value = value;
            document.getElementById('imageScaleY').value = value;
        }
        
        // ğŸ†• åº”ç”¨å›¾å±‚å˜æ¢
        async function applyImageTransform() {
            if (currentLayerIndex === null) {
                showError('è¯·å…ˆé€‰æ‹©å›¾å±‚');
                return;
            }
            
            try {
                showInfo('æ­£åœ¨åº”ç”¨å˜æ¢...');
                
                // è·å–å˜æ¢å‚æ•°
                const transform = {
                    position: {
                        x: parseFloat(document.getElementById('imagePositionX').value) || 0,
                        y: parseFloat(document.getElementById('imagePositionY').value) || 0
                    },
                    anchorPoint: {
                        x: parseFloat(document.getElementById('imageAnchorX').value) || 0,
                        y: parseFloat(document.getElementById('imageAnchorY').value) || 0
                    },
                    scale: {
                        x: parseFloat(document.getElementById('imageScaleX').value) / 100 || 1,
                        y: parseFloat(document.getElementById('imageScaleY').value) / 100 || 1
                    },
                    rotation: parseFloat(document.getElementById('imageRotation').value) || 0,
                    opacity: parseFloat(document.getElementById('imageOpacity').value) / 100 || 1
                };
                
                console.log('åº”ç”¨å˜æ¢:', transform);
                
                // è®°å½•å˜æ¢
                modifications.push({
                    layerIndex: currentLayerIndex,
                    type: 'imageTransform',
                    transform: transform
                });
                
                // ğŸ†• å°è¯•åœ¨å‰ç«¯å®æ—¶åº”ç”¨å˜æ¢åˆ°é¢„è§ˆ
                try {
                    await applyTransformToPreview(currentLayerIndex, transform);
                    console.log('âœ… å˜æ¢å·²åº”ç”¨åˆ°é¢„è§ˆ');
                } catch (error) {
                    console.warn('âš ï¸ å‰ç«¯é¢„è§ˆåº”ç”¨å˜æ¢å¤±è´¥ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼Œå˜æ¢ä¼šåœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶åº”ç”¨ï¼‰:', error.message);
                }
                
                updateHistoryDisplay();
                showSuccess('âœ… å˜æ¢å‚æ•°å·²è®°å½•å¹¶åº”ç”¨åˆ°é¢„è§ˆ');
                
            } catch (error) {
                console.error('åº”ç”¨å˜æ¢é”™è¯¯:', error);
                showError('åº”ç”¨å˜æ¢å¤±è´¥: ' + error.message);
            }
        }
        
        // ğŸ†• åº”ç”¨å˜æ¢åˆ°é¢„è§ˆï¼ˆWeb SDKï¼‰
        async function applyTransformToPreview(layerIndex, transform) {
            if (!pagFile) {
                throw new Error('PAG æ–‡ä»¶æœªåŠ è½½');
            }
            
            const LayerType = {
                Image: 5
            };
            
            console.log('ğŸ¨ å¼€å§‹åº”ç”¨å˜æ¢åˆ°é¢„è§ˆ...', transform);
            
            // è·å–å›¾å±‚
            const imageLayers = pagFile.getLayersByEditableIndex(layerIndex, LayerType.Image);
            if (!imageLayers || imageLayers.size() === 0) {
                throw new Error(`æ— æ³•è·å–å›¾å±‚ ${layerIndex}`);
            }
            
            const layer = imageLayers.get(0);
            console.log('âœ… è·å–åˆ°å›¾å±‚:', layer);
            
            // æ£€æŸ¥å¹¶åº”ç”¨å˜æ¢ API
            let appliedMethods = [];
            let failedMethods = [];
            
            // ä½ç½®
            if (transform.position && typeof layer.setPosition === 'function') {
                try {
                    layer.setPosition(transform.position.x, transform.position.y);
                    appliedMethods.push('setPosition');
                    console.log(`âœ… setPosition(${transform.position.x}, ${transform.position.y})`);
                } catch (e) {
                    failedMethods.push('setPosition: ' + e.message);
                    console.warn('âš ï¸ setPosition å¤±è´¥:', e);
                }
            }
            
            // é”šç‚¹
            if (transform.anchorPoint && typeof layer.setAnchorPoint === 'function') {
                try {
                    layer.setAnchorPoint(transform.anchorPoint.x, transform.anchorPoint.y);
                    appliedMethods.push('setAnchorPoint');
                    console.log(`âœ… setAnchorPoint(${transform.anchorPoint.x}, ${transform.anchorPoint.y})`);
                } catch (e) {
                    failedMethods.push('setAnchorPoint: ' + e.message);
                    console.warn('âš ï¸ setAnchorPoint å¤±è´¥:', e);
                }
            }
            
            // ç¼©æ”¾
            if (transform.scale && typeof layer.setScale === 'function') {
                try {
                    layer.setScale(transform.scale.x, transform.scale.y);
                    appliedMethods.push('setScale');
                    console.log(`âœ… setScale(${transform.scale.x}, ${transform.scale.y})`);
                } catch (e) {
                    failedMethods.push('setScale: ' + e.message);
                    console.warn('âš ï¸ setScale å¤±è´¥:', e);
                }
            }
            
            // æ—‹è½¬
            if (transform.rotation !== undefined && typeof layer.setRotation === 'function') {
                try {
                    layer.setRotation(transform.rotation);
                    appliedMethods.push('setRotation');
                    console.log(`âœ… setRotation(${transform.rotation})`);
                } catch (e) {
                    failedMethods.push('setRotation: ' + e.message);
                    console.warn('âš ï¸ setRotation å¤±è´¥:', e);
                }
            }
            
            // é€æ˜åº¦
            if (transform.opacity !== undefined && typeof layer.setAlpha === 'function') {
                try {
                    const alpha = Math.round(transform.opacity * 255);
                    layer.setAlpha(alpha);
                    appliedMethods.push('setAlpha');
                    console.log(`âœ… setAlpha(${alpha}) - opacity ${transform.opacity}`);
                } catch (e) {
                    failedMethods.push('setAlpha: ' + e.message);
                    console.warn('âš ï¸ setAlpha å¤±è´¥:', e);
                }
            }
            
            // åˆ·æ–°é¢„è§ˆ
            if (pagView && typeof pagView.flush === 'function') {
                try {
                    await pagView.flush();
                    console.log('âœ… é¢„è§ˆå·²åˆ·æ–°');
                } catch (e) {
                    console.warn('âš ï¸ flush å¤±è´¥:', e);
                }
            }
            
            console.log('ğŸ“Š å˜æ¢åº”ç”¨ç»Ÿè®¡:');
            console.log('  æˆåŠŸ:', appliedMethods.join(', ') || 'æ— ');
            console.log('  å¤±è´¥:', failedMethods.join(', ') || 'æ— ');
            
            if (appliedMethods.length === 0) {
                throw new Error('Web SDK ä¸æ”¯æŒä»»ä½•å˜æ¢ API');
            }
        }
        
        // ğŸ†• é‡ç½®å›¾å±‚å˜æ¢
        function resetImageTransform() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å˜æ¢å‚æ•°å—ï¼Ÿ')) {
                document.getElementById('imagePositionX').value = 0;
                document.getElementById('imagePositionY').value = 0;
                document.getElementById('imageAnchorX').value = 0;
                document.getElementById('imageAnchorY').value = 0;
                document.getElementById('imageScaleX').value = 100;
                document.getElementById('imageScaleY').value = 100;
                document.getElementById('imageRotation').value = 0;
                document.getElementById('imageOpacity').value = 100;
                document.getElementById('imageOpacityValue').textContent = '100%';
                
                showInfo('âœ… å˜æ¢å‚æ•°å·²é‡ç½®');
            }
        }

        // æ›´æ–°å›¾ç‰‡
        async function updateImage() {
            if (currentLayerIndex === null) {
                showError('è¯·å…ˆé€‰æ‹©å›¾å±‚');
                return;
            }
            
            const file = document.getElementById('imageInput').files[0];
            if (!file) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            try {
                showSuccess('æ­£åœ¨å¤„ç†å›¾ç‰‡ï¼Œè¯·ç¨å€™...');
                
                // è¯»å–å›¾ç‰‡ä¸º base64ï¼ˆç”¨äºæœåŠ¡ç«¯å¯¼å‡ºï¼‰
                const imageBase64 = await readFileAsBase64(file);
                
                // ä½¿ç”¨ PAG SDK æ­£ç¡®åŠ è½½å›¾ç‰‡ï¼ˆç”¨äºé¢„è§ˆï¼‰
                const pagImage = await loadImageAsPAGImage(file);
                await pagFile.replaceImage(currentLayerIndex, pagImage);
                
                modifications.push({
                    layerIndex: currentLayerIndex,
                    type: 'image',
                    value: file.name,
                    imageData: imageBase64 // ä¿å­˜ base64 æ•°æ®ç”¨äºæœåŠ¡ç«¯å¯¼å‡º
                });
                
                updateHistoryDisplay(); // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
                await renderPreview();
                showSuccess(`âœ… å›¾ç‰‡å›¾å±‚ ${currentLayerIndex} æ›´æ–°æˆåŠŸï¼æ–‡ä»¶: ${file.name}`);
                
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©
                document.getElementById('imageInput').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                
            } catch (error) {
                console.error('å›¾ç‰‡æ›´æ–°é”™è¯¯:', error);
                showError('æ›´æ–°å›¾ç‰‡å¤±è´¥: ' + error.message);
            }
        }

        // è¯»å–æ–‡ä»¶ä¸º base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // åŠ è½½å›¾ç‰‡ä¸º PAGImage å¯¹è±¡
        async function loadImageAsPAGImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    img.src = e.target.result;
                    img.onload = async () => {
                        try {
                            // åˆ›å»º Canvas å¹¶ç»˜åˆ¶å›¾ç‰‡
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            // ä½¿ç”¨ PAG SDK ä» Canvas åˆ›å»º PAGImage
                            const pagImage = await window.PAG.PAGImage.fromSource(canvas);
                            resolve(pagImage);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                };
                
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsDataURL(file);
            });
        }

        // æ¸²æŸ“é¢„è§ˆ
        async function renderPreview() {
            const canvas = document.getElementById('pag');
            canvas.width = pagFile.width();
            canvas.height = pagFile.height();

            if (pagView) {
                await pagView.destroy();
            }
            
            pagView = await window.PAG.PAGView.init(pagFile, canvas);
            
            // ğŸ†• åº”ç”¨æ‰€æœ‰å·²è®°å½•çš„å˜æ¢åˆ°é¢„è§ˆ
            await applyAllTransformsToPreview();
        }
        
        // ğŸ†• åº”ç”¨æ‰€æœ‰å˜æ¢åˆ°é¢„è§ˆ
        async function applyAllTransformsToPreview() {
            if (!pagFile || !modifications || modifications.length === 0) {
                return;
            }
            
            console.log('ğŸ¨ å¼€å§‹åº”ç”¨æ‰€æœ‰å˜æ¢åˆ°é¢„è§ˆ...');
            
            for (const mod of modifications) {
                if (mod.type === 'imageTransform') {
                    try {
                        await applyTransformToPreview(mod.layerIndex, mod.transform);
                        console.log(`âœ… å›¾å±‚ ${mod.layerIndex} å˜æ¢å·²åº”ç”¨`);
                    } catch (error) {
                        console.warn(`âš ï¸ å›¾å±‚ ${mod.layerIndex} å˜æ¢åº”ç”¨å¤±è´¥:`, error.message);
                    }
                }
            }
            
            // åˆ·æ–°é¢„è§ˆ
            if (pagView && typeof pagView.flush === 'function') {
                try {
                    await pagView.flush();
                    console.log('âœ… é¢„è§ˆå·²åˆ·æ–°ï¼ˆå«æ‰€æœ‰å˜æ¢ï¼‰');
                } catch (e) {
                    console.warn('âš ï¸ flush å¤±è´¥:', e);
                }
            }
        }

        // æ’­æ”¾
        async function play() {
            if (!pagView) return;
            await pagView.play();
        }

        // åœæ­¢
        function stop() {
            if (!pagView) return;
            pagView.stop();
        }

        // ä¸‹è½½ PAG - æ³¨æ„ï¼šWeb SDK ä¸æ”¯æŒå¯¼å‡ºä¿®æ”¹
        async function downloadPAG() {
            if (!pagFile) {
                showError('è¯·å…ˆåŠ è½½ PAG æ–‡ä»¶');
                return;
            }
            
            showError('âš ï¸ é‡è¦æç¤ºï¼šPAG Web SDK ä¸æ”¯æŒå¯¼å‡ºä¿®æ”¹åçš„æ–‡ä»¶ã€‚\n\nå»ºè®®ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š\n1. ä½¿ç”¨ Python/Node.js ç‰ˆæœ¬çš„ PAG SDK è¿›è¡Œæ‰¹é‡ç¼–è¾‘\n2. è®°å½•ä¿®æ”¹é…ç½®ï¼ˆç‚¹å‡»"å¯¼å‡ºå½“å‰é…ç½®"ï¼‰ï¼Œç„¶ååœ¨ After Effects ä¸­åº”ç”¨\n3. ä½¿ç”¨æœ¬ç¼–è¾‘å™¨é¢„è§ˆæ•ˆæœï¼Œç¡®è®¤ååœ¨ AE ä¸­æ‰‹åŠ¨ä¿®æ”¹');
        }

        // å¯¼å‡ºé…ç½®ä¸º JSONï¼ˆæ¨èæ–¹å¼ï¼‰
        function exportJSONConfig() {
            if (modifications.length === 0) {
                showError('æš‚æ— ä¿®æ”¹è®°å½•');
                return;
            }
            
            const config = {
                modifications: modifications,
                metadata: {
                    exportTime: new Date().toISOString(),
                    totalModifications: modifications.length
                }
            };
            
            const jsonStr = JSON.stringify(config, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pag_modifications_' + new Date().getTime() + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('âœ… é…ç½®æ–‡ä»¶å·²å¯¼å‡ºï¼å¯ç”¨äº Node.js/Python æ‰¹é‡å¤„ç†ã€‚');
        }

        // é€šè¿‡æœåŠ¡ç«¯å¯¼å‡º PAG æ–‡ä»¶ï¼ˆæ–°åŠŸèƒ½ï¼‰
        async function downloadPAGViaServer() {
            if (!originalPagBuffer) {
                showError('è¯·å…ˆåŠ è½½ PAG æ–‡ä»¶');
                return;
            }
            
            if (modifications.length === 0) {
                showError('æš‚æ— ä¿®æ”¹ï¼Œæ— éœ€å¯¼å‡º');
                return;
            }
            
            try {
                showSuccess('æ­£åœ¨è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¨å€™...');
                
                // å‡†å¤‡è¡¨å•æ•°æ®
                const formData = new FormData();
                
                // æ·»åŠ åŸå§‹ PAG æ–‡ä»¶
                const pagBlob = new Blob([originalPagBuffer], { type: 'application/octet-stream' });
                formData.append('pagFile', pagBlob, 'template.pag');
                
                // æ·»åŠ ä¿®æ”¹é…ç½®ï¼ˆå›¾ç‰‡ä½œä¸ºå•ç‹¬çš„ Blob ä¸Šä¼ ï¼‰
                const modificationsConfig = await prepareModificationsForServer(formData);
                formData.append('modifications', JSON.stringify(modificationsConfig));
                
                // å‘é€åˆ°æœåŠ¡å™¨
                const serverUrl = 'http://localhost:5000/api/export-pag';
                
                const response = await fetch(serverUrl, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
                }
                
                // ä¸‹è½½è¿”å›çš„æ–‡ä»¶
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'modified_' + new Date().getTime() + '.pag';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('âœ… PAG æ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
                
            } catch (error) {
                console.error('æœåŠ¡ç«¯å¯¼å‡ºé”™è¯¯:', error);
                
                if (error.message.includes('Failed to fetch')) {
                    showError('âŒ æ— æ³•è¿æ¥åˆ°å¯¼å‡ºæœåŠ¡å™¨\n\nè¯·ç¡®ä¿å·²å¯åŠ¨æœåŠ¡å™¨ï¼š\npython pag/pag_export_server.py\n\næˆ–ä½¿ç”¨"å¯¼å‡ºé…ç½® JSON"åŠŸèƒ½');
                } else {
                    showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
                }
            }
        }

        // å‡†å¤‡ä¿®æ”¹æ•°æ®ç”¨äºæœåŠ¡å™¨å¤„ç†ï¼ˆä¼˜åŒ–ç‰ˆï¼šå›¾ç‰‡å•ç‹¬ä¸Šä¼ ï¼‰
        async function prepareModificationsForServer(formData) {
            const prepared = [];
            let imageIndex = 0;
            
            for (const mod of modifications) {
                if (mod.type === 'text') {
                    // æ–‡æœ¬ç›´æ¥ä½¿ç”¨
                    prepared.push({
                        layerIndex: mod.layerIndex,
                        type: 'text',
                        value: mod.value
                    });
                } else if (mod.type === 'image') {
                    // å›¾ç‰‡æ•°æ®å•ç‹¬ä½œä¸º Blob ä¸Šä¼ ï¼ŒJSON ä¸­åªä¿å­˜å¼•ç”¨
                    if (mod.imageData && mod.imageData.startsWith('data:image/')) {
                        // è§£ç  base64 ä¸º Blob
                        const base64Data = mod.imageData.split(',')[1];
                        const mimeType = mod.imageData.split(':')[1].split(';')[0];
                        const byteString = atob(base64Data);
                        const arrayBuffer = new ArrayBuffer(byteString.length);
                        const uint8Array = new Uint8Array(arrayBuffer);
                        for (let i = 0; i < byteString.length; i++) {
                            uint8Array[i] = byteString.charCodeAt(i);
                        }
                        const blob = new Blob([arrayBuffer], { type: mimeType });
                        
                        // æ·»åŠ åˆ° FormData ä¸­
                        const imageFieldName = `image_${imageIndex}`;
                        formData.append(imageFieldName, blob, `layer_${mod.layerIndex}.png`);
                        
                        // JSON ä¸­åªä¿å­˜å¼•ç”¨
                        prepared.push({
                            layerIndex: mod.layerIndex,
                            type: 'image',
                            value: imageFieldName  // å¼•ç”¨ FormData ä¸­çš„å­—æ®µå
                        });
                        
                        imageIndex++;
                    } else {
                        // å¦‚æœæ˜¯æ–‡ä»¶è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨
                        prepared.push({
                            layerIndex: mod.layerIndex,
                            type: 'image',
                            value: mod.value
                        });
                    }
                }
            }
            
            return prepared;
        }

        // åº”ç”¨ JSON é…ç½®å¹¶å¯¼å‡º PAGï¼ˆä¸€é”®åŠŸèƒ½ï¼‰
        async function applyJSONAndExportPAG() {
            if (!originalPagBuffer) {
                showError('è¯·å…ˆåŠ è½½ PAG æ–‡ä»¶');
                return;
            }

            const jsonText = document.getElementById('jsonConfig').value.trim();
            
            if (!jsonText) {
                // å¦‚æœæ²¡æœ‰æ‰‹åŠ¨è¾“å…¥ JSONï¼Œä½¿ç”¨å½“å‰çš„ä¿®æ”¹è®°å½•
                if (modifications.length === 0) {
                    showError('è¯·å…ˆè¿›è¡Œä¿®æ”¹æˆ–è¾“å…¥ JSON é…ç½®');
                    return;
                }
                
                showSuccess('ä½¿ç”¨å½“å‰ä¿®æ”¹è®°å½•å¯¼å‡º PAG...');
                await downloadPAGViaServer();
                return;
            }

            try {
                // è§£æ JSON é…ç½®
                const config = JSON.parse(jsonText);
                
                if (!config.modifications || !Array.isArray(config.modifications)) {
                    showError('JSON æ ¼å¼é”™è¯¯ï¼šéœ€è¦åŒ…å« modifications æ•°ç»„');
                    return;
                }

                showSuccess(`ğŸ“‹ æ­£åœ¨åº”ç”¨ ${config.modifications.length} é¡¹é…ç½®...`);

                // å‡†å¤‡å‘é€åˆ°æœåŠ¡å™¨çš„æ•°æ®
                const formData = new FormData();
                
                // æ·»åŠ åŸå§‹ PAG æ–‡ä»¶
                const pagBlob = new Blob([originalPagBuffer], { type: 'application/octet-stream' });
                formData.append('pagFile', pagBlob, 'template.pag');
                
                // å¤„ç†é…ç½®ä¸­çš„ä¿®æ”¹ï¼ˆæ”¯æŒ base64 å›¾ç‰‡ï¼‰
                const processedModifications = [];
                
                for (const mod of config.modifications) {
                    if (mod.type === 'text') {
                        processedModifications.push({
                            layerIndex: mod.layerIndex,
                            type: 'text',
                            value: mod.value
                        });
                    } else if (mod.type === 'image') {
                        processedModifications.push({
                            layerIndex: mod.layerIndex,
                            type: 'image',
                            value: mod.imageData || mod.value
                        });
                    }
                }
                
                formData.append('modifications', JSON.stringify(processedModifications));
                
                // å‘é€åˆ°æœåŠ¡å™¨
                showSuccess('â³ æ­£åœ¨è¿æ¥æœåŠ¡å™¨ç”Ÿæˆ PAG æ–‡ä»¶...');
                const serverUrl = 'http://localhost:5000/api/export-pag';
                
                const response = await fetch(serverUrl, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
                }
                
                // ä¸‹è½½ç”Ÿæˆçš„æ–‡ä»¶
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'modified_from_json_' + new Date().getTime() + '.pag';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('âœ… PAG æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼å·²åº”ç”¨ ' + config.modifications.length + ' é¡¹ä¿®æ”¹');
                
            } catch (error) {
                console.error('åº”ç”¨ JSON å¹¶å¯¼å‡ºé”™è¯¯:', error);
                
                if (error instanceof SyntaxError) {
                    showError('âŒ JSON æ ¼å¼é”™è¯¯ï¼š' + error.message);
                } else if (error.message.includes('Failed to fetch')) {
                    showError('âŒ æ— æ³•è¿æ¥åˆ°å¯¼å‡ºæœåŠ¡å™¨\n\nè¯·ç¡®ä¿å·²å¯åŠ¨æœåŠ¡å™¨ï¼š\npython pag/pag_export_server.py\n\næˆ–è¿è¡Œ pag/start_pag_export_server.bat');
                } else {
                    showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
                }
            }
        }

        // åº”ç”¨ JSON é…ç½®
        async function applyJSONConfig() {
            const jsonText = document.getElementById('jsonConfig').value;
            
            try {
                const config = JSON.parse(jsonText);
                
                for (const mod of config.modifications) {
                    if (mod.type === 'text') {
                        const textData = await pagFile.getTextData(mod.layerIndex);
                        textData.text = mod.value;
                        await pagFile.replaceText(mod.layerIndex, textData);
                    }
                    // å›¾ç‰‡éœ€è¦å®é™…çš„å›¾ç‰‡æ•°æ®ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
                }
                
                await renderPreview();
                showSuccess('âœ… JSON é…ç½®åº”ç”¨æˆåŠŸï¼');
                
            } catch (error) {
                showError('åº”ç”¨ JSON é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸ
        function showSuccess(message) {
            const successEl = document.getElementById('success');
            successEl.textContent = message;
            successEl.classList.add('show');
            setTimeout(() => successEl.classList.remove('show'), 3000);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', initPAG);
    </script>
</body>
</html>

